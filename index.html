let history = []; 
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const btn = document.getElementById('send');
const ALPACA_ICON = "https://image.rakuten.co.jp/alpacapc/cabinet/item_new/06703877/imgrc0111028335.jpg";

// â˜…åº—èˆ—ã®é€£çµ¡å…ˆURLè¨­å®š
const URL_FORM = "https://www.alpaca-pc.com/ssl/contact/";
const URL_LINE = "https://page.line.me/544rnszi?oat_content=url&openQrModal=true";
const SHOP_PHONE = "048-577-7990";

// ãƒãƒƒãƒ—ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
function sendChip(element) {
  const text = element.innerText;
  input.value = text; 
  sendMessage();      
}

// â˜… Markdownã‚’HTMLã«å¤‰æ›ã™ã‚‹é­”æ³•ã®é–¢æ•° â˜…
function parseMarkdown(text) {
  if (!text) return "";
  let html = text;
  // 1. **å¤ªå­—** ã‚’ <b>å¤ªå­—</b> ã«å¤‰æ›
  html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
  // 2. æ”¹è¡Œã‚³ãƒ¼ãƒ‰(\n) ã‚’ <br> ã«å¤‰æ›
  html = html.replace(/\n/g, '<br>');
  return html;
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addMsg(text, 'user');
  input.value = '';
  input.disabled = true;

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, history: history })
    });
    const data = await res.json();
    
    // ã“ã“ã§å¤‰æ›ã—ã¦ã‹ã‚‰è¡¨ç¤ºï¼
    addMsg(data.reply, 'bot');
    
    history.push({ role: 'user', content: text });
    history.push({ role: 'assistant', content: data.reply });

  } catch (e) {
    addMsg("ã”ã‚ã‚“ã­ã€ã¡ã‚‡ã£ã¨èª¿å­ãŒæ‚ªã„ã¿ãŸã„â€¦ã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
  } finally {
    input.disabled = false;
    input.focus();
  }
}

function addMsg(rawText, role) {
  const row = document.createElement('div');
  row.className = `msg-row ${role}`;
  
  // HTMLã‚¿ã‚°ã«å¤‰æ›ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã¯ãã®ã¾ã¾ã€Botã®å…¥åŠ›ã ã‘å¤‰æ›ã—ã¦ã‚‚OKã§ã™ãŒã€ä¸¡æ–¹é€šã—ã¦ã‚‚å®‰å…¨ã§ã™ï¼‰
  const formattedText = parseMarkdown(rawText);

  if (role === 'bot') {
    // â˜…é‡è¦ï¼šéå»ã®ã€Œå•ã„åˆã‚ã›ãƒœã‚¿ãƒ³ã€ã‚’ç”»é¢ã‹ã‚‰ã™ã¹ã¦æ¶ˆã™
    const existingButtons = document.querySelectorAll('.support-container');
    existingButtons.forEach(btn => btn.remove());

    const img = document.createElement('img');
    img.src = ALPACA_ICON;
    img.className = 'icon';
    
    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.gap = '5px';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    // innerHTMLã‚’ä½¿ã£ã¦ã‚¿ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    bubble.innerHTML = formattedText;
    container.appendChild(bubble);

    // â˜… é–‹é–‰å¼ã®å•ã„åˆã‚ã›ã‚¨ãƒªã‚¢ â˜…
    const supportContainer = document.createElement('div');
    supportContainer.className = 'support-container';

    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'toggle-btn';
    toggleBtn.innerHTML = 'ğŸ’â€â™€ï¸ è§£æ±ºã—ãªã„ã®ã§æ‹…å½“è€…ã«å•ã„åˆã‚ã›ã‚‹';
    
    const details = document.createElement('div');
    details.className = 'details-area';
    details.innerHTML = `
      <div class="phone-section">
        <a href="tel:${SHOP_PHONE}" class="phone-number">ğŸ“ ${SHOP_PHONE}</a>
        <span class="phone-hours">é›»è©±å—ä»˜æ™‚é–“ï¼šå¹³æ—¥10æ™‚ï½17æ™‚(åœŸæ—¥ç¥é™¤ã)</span>
        
        <div class="alert-box">
          <b>âš ï¸ é›»è©±ã¯æ··ã¿åˆã„ã€ç¹‹ãŒã‚Šã«ãã„å ´åˆãŒã”ã–ã„ã¾ã™ã€‚</b><br>
          <span style="color:#333; display:block; margin-top:5px;">
            ãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯LINEãªã‚‰<b>1å–¶æ¥­æ—¥ä»¥å†…</b>ã«è¿”ä¿¡ã„ãŸã—ã¾ã™ã€‚
          </span>
        </div>
      </div>

      <a href="${URL_FORM}" target="_blank" class="action-btn btn-form">
        âœ‰ï¸ ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ 
      </a>

      <a href="${URL_LINE}" target="_blank" class="action-btn btn-line">
        ğŸ’¬ LINEã§ãŠå•ã„åˆã‚ã›
      </a>
    `;

    toggleBtn.onclick = () => {
      details.classList.toggle('show');
      if(details.classList.contains('show')) {
        toggleBtn.innerHTML = 'âœ– é–‰ã˜ã‚‹';
      } else {
        toggleBtn.innerHTML = 'ğŸ’â€â™€ï¸ è§£æ±ºã—ãªã„ã®ã§æ‹…å½“è€…ã«å•ã„åˆã‚ã›ã‚‹';
      }
    };

    supportContainer.appendChild(toggleBtn);
    supportContainer.appendChild(details);
    container.appendChild(supportContainer);

    row.appendChild(img);
    row.appendChild(container);

  } else {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = formattedText; // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚‚æ”¹è¡Œãªã©åæ˜ 
    row.appendChild(bubble);
  }

  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

btn.onclick = sendMessage;
input.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };