<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>アルパカPC トラブル解決チャット</title>
<style>
  body { font-family: "Helvetica Neue", Arial, sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; height: 100vh; }
  .chat-container { width: 100%; max-width: 600px; background: #fff; display: flex; flex-direction: column; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  .header { background: #333; color: #fff; padding: 15px; text-align: center; font-weight: bold; font-size: 1.2em; }
  .chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
  .message { padding: 12px 16px; border-radius: 12px; max-width: 80%; line-height: 1.5; white-space: pre-wrap; animation: fadeIn 0.3s ease; }
  .bot { background: #e4e6eb; align-self: flex-start; color: #000; border-bottom-left-radius: 2px; }
  .user { background: #0084ff; align-self: flex-end; color: #fff; border-bottom-right-radius: 2px; }
  .options { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
  .btn { padding: 8px 16px; border: 1px solid #0084ff; background: #fff; color: #0084ff; border-radius: 20px; cursor: pointer; transition: 0.2s; font-size: 0.9em; }
  .btn:hover { background: #0084ff; color: #fff; }
  .btn-primary { background: #0084ff; color: #fff; }
  .input-area { padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; background: #fff; }
  input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
  button#send { padding: 10px 20px; background: #333; color: #fff; border: none; border-radius: 20px; cursor: pointer; }
  button#send:disabled { background: #ccc; }
  .ticket-box { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9em; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="chat-container">
  <div class="header">アルパカPC サポートチャット</div>
  <div class="chat-box" id="chatBox"></div>
  <div class="input-area" id="inputArea">
    <input type="text" id="userInput" placeholder="症状を入力（例：電源が入らない）" />
    <button id="send">送信</button>
  </div>
</div>

<script>
// 設定（必要に応じて書き換えてください）
const JSON_URL = 'data/support_kb.json?v=3'; 
const SUPPORT_INFO = "解決しない場合は、以下の文章をコピーして\nメール(support@alpaca-pc.com) または お電話でお伝えください。";

let kbData = null;
let currentTrouble = null;
let historyLog = []; // 診断ログ

const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('send');
const inputArea = document.getElementById('inputArea');

// 初期化
async function init() {
  try {
    const res = await fetch(JSON_URL);
    if (!res.ok) throw new Error("Data load failed");
    kbData = await res.json();
    addBotMessage(kbData.default_msg);
    showTopOptions();
  } catch (e) {
    addBotMessage("データの読み込みに失敗しました。ページを更新してください。");
  }
}

// メッセージ表示系
function addBotMessage(text) {
  const div = document.createElement('div');
  div.className = 'message bot';
  div.textContent = text;
  chatBox.appendChild(div);
  scrollToBottom();
  return div;
}

function addUserMessage(text) {
  const div = document.createElement('div');
  div.className = 'message user';
  div.textContent = text;
  chatBox.appendChild(div);
  scrollToBottom();
}

function addOptions(options, callback) {
  const div = document.createElement('div');
  div.className = 'options';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = opt.label;
    btn.onclick = () => {
      div.remove(); // ボタンを押したら消す（履歴に残さないため）
      addUserMessage(opt.label);
      callback(opt);
    };
    div.appendChild(btn);
  });
  // botメッセージの直後に追加
  chatBox.lastElementChild.appendChild(div);
  scrollToBottom();
}

function scrollToBottom() {
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ロジック系
function showTopOptions() {
  // JSONのカテゴリ一覧をボタンとして出す
  const opts = kbData.troubles.map(t => ({ label: t.label, value: t.id }));
  addOptions(opts, (opt) => startDiagnosis(opt.value));
}

function findTroubleByText(text) {
  // キーワードマッチング
  for (const t of kbData.troubles) {
    if (t.keywords.some(k => text.includes(k))) {
      return t.id;
    }
  }
  return null;
}

function startDiagnosis(troubleId) {
  currentTrouble = kbData.troubles.find(t => t.id === troubleId);
  historyLog.push(`カテゴリ: ${currentTrouble.label}`);
  
  // 最初の質問を表示（あれば）
  if (currentTrouble.questions && currentTrouble.questions.length > 0) {
    askQuestion(0);
  } else {
    // 質問がなければ解決策へ（簡易版）
    showSolution(Object.keys(currentTrouble.solutions)[0]);
  }
}

function askQuestion(index) {
  const q = currentTrouble.questions[index];
  addBotMessage(q.text);
  
  // 選択肢の処理
  const opts = q.options.map(o => ({ ...o, qIndex: index }));
  addOptions(opts, (choice) => {
    historyLog.push(`Q: ${q.text} -> A: ${choice.label}`);
    
    // 次のアクションへ
    if (choice.next.startsWith('step_')) {
      showSolution(choice.next);
    } else if (choice.next.startsWith('q_')) {
      // 次の質問へ（ID検索などは省略、配列順で簡易実装も可だが今回はnext指定）
      // ※簡易実装のため、solutionsへ誘導
      addBotMessage("状況を確認しました。");
    }
  });
}

function showSolution(stepId) {
  const sol = currentTrouble.solutions[stepId];
  if (!sol) return;

  addBotMessage(sol.text);
  historyLog.push(`提案: ${sol.text.split('\n')[0]}`);

  // 解決したか聞く
  setTimeout(() => {
    addBotMessage("これで改善しましたか？");
    addOptions([
      { label: "直った！", val: true },
      { label: "直らない", val: false }
    ], (res) => {
      if (res.val) {
        addBotMessage("よかったです！また何かあればご相談ください。");
        // リセットボタンなど
        addOptions([{label: "最初に戻る", next: "reset"}], () => location.reload());
      } else {
        historyLog.push("結果: 改善せず");
        generateTicket();
      }
    });
  }, 800);
}

function generateTicket() {
  const ticket = `
【サポート依頼】
■トラブル内容
${historyLog.join('\n')}

■お客様希望
担当者によるサポート希望
`.trim();

  addBotMessage(SUPPORT_INFO);
  
  const div = document.createElement('div');
  div.className = 'ticket-box';
  div.innerText = ticket;
  chatBox.appendChild(div);

  // コピーボタン
  const copyBtn = document.createElement('button');
  copyBtn.className = 'btn btn-primary';
  copyBtn.textContent = '文章をコピーする';
  copyBtn.style.marginTop = '10px';
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(ticket);
    alert('コピーしました');
  };
  chatBox.appendChild(copyBtn);
  scrollToBottom();
}

// フリー入力の処理
sendBtn.onclick = handleInput;
userInput.onkeypress = (e) => { if(e.key === 'Enter') handleInput(); };

function handleInput() {
  const text = userInput.value.trim();
  if (!text) return;
  
  addUserMessage(text);
  userInput.value = '';

  // キーワードからカテゴリ推定
  const tid = findTroubleByText(text);
  if (tid) {
    startDiagnosis(tid);
  } else {
    addBotMessage(kbData.not_found_msg);
    showTopOptions(); // 選択肢に戻す
  }
}

init();
</script>
</body>
</html>